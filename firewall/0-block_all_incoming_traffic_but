#!/bin/bash

echo -e "Configuring firewall with iptables...\n"

# Completely flush all iptables rules
sudo iptables -F
sudo iptables -X
sudo iptables -t nat -F
sudo iptables -t nat -X
sudo iptables -t mangle -F
sudo iptables -t mangle -X

# Set default policies to DROP
sudo iptables -P INPUT DROP
sudo iptables -P FORWARD DROP
sudo iptables -P OUTPUT ACCEPT

# Allow loopback traffic
sudo iptables -A INPUT -i lo -j ACCEPT

# Allow established connections
sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# Allow specific ports (SSH, HTTP, HTTPS)
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# Log dropped packets (optional, for debugging)
sudo iptables -A INPUT -j LOG --log-prefix "FILTERED: " --log-level 4

# Make sure rules persist after reboot
sudo apt-get install -y iptables-persistent
sudo sh -c "iptables-save > /etc/iptables/rules.v4"

# Disable UFW if it's enabled (to avoid conflicts)
if command -v ufw &> /dev/null; then
    sudo ufw disable
fi

echo -e "Firewall configured to FILTER all incoming connections except ports 22, 80, and 443.\n"
